<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=0.5,minimum-scale=0.5,maximum-scale=0.5,user-scalable=no" />
    <title>我的订单</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css">
    <!-- <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css"> -->
    
    <link rel="stylesheet" href="css/order_style.css" />
    <link rel="stylesheet" href="css/myOrder.css" />

</head>

<body>
    <div class="wrap">
        <!-- <div class="head">
				<div class="back">
					<img src="images/wback.png" alt="" />
				</div>
				<p class="sure">我的订单</p>
				<div class="message">
					<img src="images/message.png" alt="" />
				</div>
			</div> -->
        <header class="header">
            <ul class='header_ul'>
                <li><a style="color: #000;" href="all_order.html">全部</a></li>
                <li><a style="color: #000;" href="my_order.html">待付款</a></li>
                <li class='active'><a href="payd_ordor.html">已付款</a></li>
                <li><a style="color: #000;" href="over_order.html">已发货</a></li>
            </ul>
        </header>
        <div id="order_box">
        </div>
        <!--当没有商品时显示的样式-->
        <!--<div class="no_goods">
				<img src="../image/noGoods.png" alt="" />
				<p>您还没有相关订单！</p>
				<button class="stroll_btn">去逛逛</button>
			</div>-->
        <!--当没有商品时显示的样式-->
      

</body>

</html>
<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>
<script src="js/order.js"></script>
<script src="js/jwerixin.js"></script>
<script>
    $.ajax({
        url: "https://mask.zhixiutec.com/api/user",
        success: function (res) {
            console.log('res', res)
            if (res && res.error_code === 0) {
                var data = res.data;
                var hasAdress = true;
                if (!data.phone && !data.address) {
                    hasAdress = false;
                }
                $.ajax({
                    url: 'https://mask.zhixiutec.com/api/my_order?type=finish',
                    success: function (res) {
                        if (res && res.error_code === 0) {
                            var data = res.data;
                            var str = '';
                            for (var i = 0; i < data.length; i++) {
                                str += `
                    <div class="bgc"></div>
        <div class="myGoods">
            <div class="mg_goods clearfix">
                <img class="mg_img" src="images/order_goods.png" alt="" />
                <div class='mg_text'>
                    <div class="mg_title clearfix">
                        <p class="mg_h">现货&nbsp;瑞典进口&nbsp;ICA50%&nbsp;水果坚果燕麦片即食免煮&nbsp;冲饮早餐代餐</p>
                        <div class="mg_score">
                            <p class="mg_money">￥${data[i].spend}</p>
                        </div>
                        <div class='mg_sub clearfix'>
                            <p class="sub_title">50%&nbsp;水果坚果&nbsp;750g</p>
                            <p class="sub_num">x<span>${data[i].count}</span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="total_goods">
                订单号:<span>${data[i].order_id}</span>
            </div>
            <div class="wait_pay clearfix">
				<div class="wp_left">等待买家付款</div>
                <div class="wp_right">
                    ${hasAdress===false ? '<p class="del">添加地址</p>':''}
                    <p class="pay" data-id=${data[i].ID}>立即付款</p>
				</div>
			</div>
        </div>
                    `
                            }
                            if(data.length>0){
                                $('#order_box').append(str)
                            }else{
                                $('#order_box').append('<p style="margin-top:40">暂无订单</p>')
                            }
                            
                            $('.del').on('click',function(){
                                window.open('address.html',"_self")
                            })
                            $('.pay').on('click', function () {
                                $.ajax({
                                    url: 'https://mask.zhixiutec.com/api/pay',
                                    type: 'post',
                                    data: JSON.stringify({ "id": parseInt($(this).attr('data-id')) }),
                                    success: function (res) {
                                        console.log('res',res)
                                        if(res.error_code ===1){
                                            $.toast(res.err_msg, "cancel");
                                            return;
                                        }
                                        var result = res.data;
                                        wx.config({
                                            debug: false,
                                            appId: result["appId"],
                                            timestamp: result["timeStamp"],
                                            nonceStr: result["nonceStr"],
                                            signature: result["signature"],
                                            jsApiList: [
                                                'chooseWXPay',
                                                'updateTimelineShareData'
                                            ]
                                        });
                                        wx.ready(function () {

                                            wx.chooseWXPay({
                                                appId: result["appId"],
                                                timestamp: result["timeStamp"], // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                                                nonceStr: result["nonceStr"], // 支付签名随机串，不长于 32 位
                                                package: result["package"], // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）
                                                signType: result["signType"], // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                                                paySign: result["sign"], // 支付签名
                                                success: function (res) {
                                                    window.open('userhome.html', "_self")
                                                },

                                                fail: function (res) {
                                                    $.hideLoading()
                                                    // alert('支付失败!');
                                                    toast("支付失败！请检查微信配置");
                                                },
                                                cancel: function (res) {

                                                    // //支付取消
                                                    $.hideLoading()
                                                    toast("已取消支付！");
                                                }
                                            });
                                        });

                                    }
                                })
                            })
                        }
                    }
                })
            }
        }
    })



</script>